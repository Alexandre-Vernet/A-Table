<div class="p-3">
    @if (updateRecipe && updateRecipe.id) {
        <h1 class="mb-3">Mettre à jour une recette</h1>
    } @else {
        <h1 class="mb-3">Ajouter une recette</h1>
    }
    <form [formGroup]="formCreateRecipe" (ngSubmit)="submitCreateRecipe()">

        <!--Recipe info-->
        <h2 class="text-primary mb-3">Détail de la recette</h2>
        <div class="flex flex-column gap-5 mb-3">
            <p-floatlabel variant="on">
                <input id="name" formControlName="name" pInputText autocomplete="off" placeholder="Pancakes"
                       pSize="large"/>
                <label for="name">Nom de la recette</label>
                @if (formCreateRecipe.controls.name.touched) {
                    <p-message severity="error" size="small" variant="simple">
                        @if (formCreateRecipe.controls.name.hasError('required')) {
                            Champ requis
                        }
                        @if (formCreateRecipe.controls.name.hasError('minlength')) {
                            Ce champ nécessite 5 caractères minimum
                        }
                        @if (formCreateRecipe.controls.name.hasError('maxlength')) {
                            Ce champ ne peut pas dépasser 50 caractères
                        }
                    </p-message>
                }
            </p-floatlabel>


            <div class="flex flex-row gap-4">
                <p-floatlabel variant="on" class="flex-1">
                    <p-select id="category" inputId="category" formControlName="category" [options]="categories"
                               class="w-full"/>
                    <label for="category">Catégorie</label>
                    @if (formCreateRecipe.controls.category.touched) {
                        <p-message severity="error" size="small" variant="simple">
                            @if (formCreateRecipe.controls.category.hasError('required')) {
                                Champ requis
                            }
                        </p-message>
                    }
                </p-floatlabel>

                <p-floatlabel variant="on" class="flex-1">
                    <input id="nbPerson" formControlName="nbPerson" pInputText autocomplete="off" class="w-full"
                           min="1"/>
                    <label for="nbPerson">Nombre de personnes</label>
                    @if (formCreateRecipe.controls.nbPerson.touched) {
                        <p-message severity="error" size="small" variant="simple">
                            @if (formCreateRecipe.controls.nbPerson.hasError('min')) {
                                Ce champ doit être supérieur à 1
                            }
                            @if (formCreateRecipe.controls.nbPerson.hasError('max')) {
                                Ce champ doit être inférieur à 50
                            }
                        </p-message>
                    }
                </p-floatlabel>
            </div>


            <div class="flex flex-row gap-2 flex-wrap">
                <p-floatlabel variant="on" class="flex-1">
                    <p-inputNumber class="w-full" id="preparationTime" formControlName="preparationTime"
                                   autocomplete="off" [min]="1"
                                   placeholder="15 mn" suffix=" mn"/>
                    <label for="preparationTime">Temps de préparation</label>
                    @if (formCreateRecipe.controls.preparationTime.touched) {
                        <p-message severity="error" size="small" variant="simple">
                            @if (formCreateRecipe.controls.preparationTime.hasError('min')) {
                                Ce champ doit être supérieur à 1
                            }
                            @if (formCreateRecipe.controls.preparationTime.hasError('max')) {
                                Ce champ doit être inférieur à 999
                            }
                        </p-message>
                    }
                </p-floatlabel>

                <p-floatlabel variant="on" class="flex-1">
                    <p-inputNumber class="w-full" id="cookingTime" formControlName="cookingTime" autocomplete="off"
                                   [min]="0" placeholder="45mn" suffix=" mn"/>
                    <label for="cookingTime">Temps de cuisson</label>
                    @if (formCreateRecipe.controls.cookingTime.touched) {
                        <p-message severity="error" size="small" variant="simple">
                            @if (formCreateRecipe.controls.cookingTime.hasError('min')) {
                                Ce champ doit être supérieur à 0
                            }
                            @if (formCreateRecipe.controls.cookingTime.hasError('max')) {
                                Ce champ doit être inférieur à 999
                            }
                        </p-message>
                    }
                </p-floatlabel>
            </div>

            <div class="flex flex-column gap-2">
                @if (formCreateRecipe.controls.image.value) {
                    <img class="recipe-image" [src]="formCreateRecipe.controls.image.value" alt="recipe">
                }
                <p-fileupload mode="basic"
                              [chooseLabel]="updateRecipe?.image ? 'Mettre à jour l\'image' : 'Importer une image'"
                              chooseIcon="pi pi-upload" name="demo[]"
                              [url]="environment.uploadUrl()" accept="image/*" maxFileSize="4000000"
                              [auto]="true"
                              (onUpload)="onUpload($event)"/>

            </div>

            <p-floatlabel variant="on">
                <textarea id="note" formControlName="note" pTextarea rows="5" cols="30" style="resize: none"></textarea>
                <label for="note">Note facultative</label>
                @if (formCreateRecipe.controls.note.touched) {
                    <p-message severity="error" size="small" variant="simple">
                        @if (formCreateRecipe.controls.note.hasError('minlength')) {
                            Ce champ nécessite 5 caractères minimum
                        }
                        @if (formCreateRecipe.controls.note.hasError('maxlength')) {
                            Ce champ ne doit pas dépasser 200 caractères
                        }
                    </p-message>
                }
            </p-floatlabel>
        </div>

        <!--Ingredients-->
        <div class="flex flex-column gap-1 mb-5">
            <h2 class="text-primary mb-3">Ingrédients</h2>
            <div formArrayName="ingredients" class="flex flex-column gap-3">
                @for (ingredients of ingredientsControls; let i = $index; let first = $first; track ingredients.value) {
                    <div [formGroupName]="i" class="flex flex-row gap-2 w-full">
                        <!-- Ingredient -->
                        <div class="flex flex-column flex-1 min-w-0">
                            <p-floatlabel variant="on" class="w-full">
                                <input id="ingredient-{{ i }}" formControlName="ingredient" pInputText
                                       placeholder="Farine 150 g" (input)="changeIngredients(i)"
                                       autocomplete="off" class="w-full"/>
                                <label for="ingredient-{{ i }}">Ingrédient</label>
                            </p-floatlabel>
                            @if (ingredients.get('ingredient')?.touched || ingredients.get('ingredient')?.dirty) {
                                <p-message severity="error" size="small" variant="simple" class="w-full">
                                    @if (ingredients.get('ingredient')?.hasError('required')) {
                                        Champ requis
                                    }
                                    @if (ingredients.get('ingredient')?.invalid) {
                                        Format invalide. Exemples valides:
                                        <ul class="mt-1 ml-3 list-disc">
                                            <li>Farine 150 g</li>
                                            <li>Lait 250 mL</li>
                                            <li>Oeuf 1</li>
                                            <li>Huile d'olive 1 c à café</li>
                                        </ul>
                                    }
                                </p-message>
                            }
                            @if (ingredients.get('ingredient')?.errors?.['invalidFormat']?.['allowedUnits']) {
                                <div class="mt-2">
                                    <strong>Unités autorisées:</strong>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        @for (unit of ingredients.get('ingredient')?.errors?.['invalidFormat']?.['allowedUnits']; track unit) {
                                            <span class="px-2 py-1 bg-gray-100 rounded">{{ unit }}</span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Bouton suppression -->
                        @if (!first) {
                            <div class="flex align-items-center">
                                <i class="pi pi-minus-circle text-primary text-lg cursor-pointer"
                                   (click)="removeIngredient(i)"></i>
                            </div>
                        }
                    </div>

                }
            </div>
        </div>

        <!--Steps-->
        <div class="flex flex-column gap-1 mb-5">
            <h2 class="text-primary mb-3">Préparation</h2>
            <p-floatlabel variant="on">
                <textarea id="steps" formControlName="steps" [placeholder]="placeholderSteps"
                          pTextarea rows="20" cols="40" class="steps w-full"></textarea>
                <label for="steps">Préparation</label>
            </p-floatlabel>
            <small id="steps-help">Séparez les étapes par 2 retours à la ligne</small>
        </div>


        <p-button type="submit" icon="pi pi-check" [label]="updateRecipe ? 'Mettre à jour' : 'Créer'"
                  [loading]="loading"
                  [disabled]="!formCreateRecipe.valid || loading"/>
    </form>
</div>
